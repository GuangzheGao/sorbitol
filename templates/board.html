{% extends "base.html" %}

{% block content %}
<div class="float-header">
  <div class="board-header-name dropdown btn left">
    <a data-toggle="dropdown" data-target="#" id="rename-board">
      {{board.title}}
    </a>
    <ul aria-labelledby="rename-board" class="rename-board-menu dropdown-menu" role="menu">
      <li class="rename-board-menu-title">  Rename Board
      </li>
      <form class="dropdown-menu-form">
        <label class="menu-form menu-form-label">Name</label>
        <input id="boardNewTitle" type="text" name="name" class="js-stop-propagation" placeholder="{board.name}">
        <input type="submit" class="btn btn-success" value="Rename">
      </form>
    </ul>
  </div>
  <div class="side-bar-show-btn right">
    <a href="#" class="js-show-side-bar btn"><span class="glyphicon glyphicon-chevron-left"></span> Show Sidebar
    </a>
  </div>

</div>
<div class="side-bar panel panel-default rightpanels-board">
    <div class="members-board">
      <div class="members-header-board">
          Members 
          <a href="#" class="js-close-side-bar" style="color:#a9a9a9"><span class="glyphicon glyphicon-remove" style="float:right;"></span></a>
      </div>
      <div class="members-content-group">
        <ul class="list-group">
          {% for user in board.get_users() %}
          <li class="list-group-item">{{user.username}}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="activity-board">
      <div class="activity-header-board">
        Activity
      </div>
      <div class="activity-list-board">
        <div class="individual-activity-board">
          <div class="user-activity-board">Guangzhe Gao</div>
          <div class="activity-content-board">did not wash his hands.</div>
          <div class="activity-time-board">March 20th 2015 </div>
        </div>

        <div class="individual-activity-board">
          <div class="user-activity-board">Sicheng Liu</div>
          <div class="activity-content-board">did not watch TV.</div>
          <div class="activity-time-board">March 21th 2017 </div>
        </div>
      </div>
    </div>
  </div>
<div class="board-container js-auto-resize-to-full-window container-fluid">
  <div class="js-resize-overflow">
    <!-- To Do List -->
    {% for list in lists %}
    <div class="list-board">
      <div class="list-header-board">
        {{list.title}}
      </div>
      <div class="list-cards">
        {% for card in list.get_cards() %}
        <div class="list-card panel">
          <a class="list-card-hover" data-toggle="modal" data-target="#card-modal-{{card.id}}"><div class="list-card-title">{{card.title}}</div>
            <div class="list-card-badgets">
              <div class="list-card-badget list-card-badgets-comments">
                <span class="glyphicon glyphicon-comment"></span> {{card.get_comment_count()}}
              </div>
              <div class="list-card-badget list-card-badgets-attachments">
                <span class="glyphicon glyphicon-paperclip"></span> 0
              </div>  
            </div>

            <div class="list-card-members">
              <!--for member in card.members-->
              <div class="list-card-member">
                {member.name}
              </div> 
              <!--end for-->
            </div>
          </a> 
          <!-- Modal -->
          <div id="card-modal-{{card.id}}" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="card-modal-0" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="custom-modal-header modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                  <span class="card-title"><span class="glyphicon glyphicon-th-list"></span> {{card.title}}</span><span class="header-inline">in list <span style="font-weight: bold">{{list.title}}</span></span>            
                  <div class="card-description">
                    {% if card.get_description() %}
                      <div class="card-description-title">Description <a class="js-show-edit-card-desc-form" href="#">Edit</a></div>
                      <div>{{card.get_description()}}</div>
                    {% else %}
                      <span class="glyphicon glyphicon-pencil" style="padding-right:4px;"></span><a class="js-show-edit-card-desc-form" href="#">Edit the desciption...</a>
                    {% endif %}
                  </div>

                  <form name="edit-card-desc">
                    <div class="card-description-title">Description</div>
                    {{ edit_card_desc_form.csrf_token }}
                    <textarea class="list-cards-add-textarea" id="desc" name="desc">{% if card.get_description() %}{{card.get_description()}}{% endif %}</textarea>
                    {{ edit_card_desc_form.card_id(type="hidden", value=card.id)}}
                    <div class="edit-card-desc-form-control">
                      <input type="submit" class="btn btn-success" value="Save" />
                      <a class="close"><span class="glyphicon glyphicon-remove"></span></a>
                    </div>
                  </form> 
                </div>
                <div class="modal-body">
                  <span class="glyphicon glyphicon-bullhorn" style="padding-right:4px;"></span>Activity
                  <form name="add-comment">
                  </form>
                  <!-- for activity -->
                  <!-- endfor -->    
                </div>
              </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
          </div><!-- /.modal -->
        </div><!-- /.list-card panel -->
        {% endfor %}
        <div  class="js-list-cards-add">
          <a href="#" name="{{list.id}}">
            <div class="list-cards-add">
              Add a card...
            </div>
          </a>
        </div>
        <div class="list-cards-add-form">
          <form name="create_card">
            {{ add_card_form.csrf_token }}
            {{ add_card_form.title(class="list-cards-add-textarea") }}
            {{ add_card_form.list_id(type="hidden", value=list.id)}}
            <div class="list-cards-add-form-control">
              <input type="submit" class="btn btn-success" value="Add" />
              <a class="close"><span class="glyphicon glyphicon-remove"></span></a>
            </div>
          </form>  
        </div> 
      </div>
    </div>
    <!-- End To Do List -->
    {% endfor %}  
    <div class="add-new-list">
      <a class="js-add-new-list" href="#"><div class="list-board trans-btn">Add a list...</div></a>
      <div class="list-board list-list-add-form">
        <form name='create_list'>
          {{ add_list_form.csrf_token }}
          {{ add_list_form.title(class="list-cards-add-textarea") }}
          {{ add_list_form.board_id(type="hidden", value=board.id)}}
          <div class="list-cards-add-form-control">
            <input type="submit" class="btn btn-success" value="Add" />
            <a class="list-cards-add-form-control close"><span class="glyphicon glyphicon-remove"></span></a>
          </div>
        </form> 
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block javascript %}
<script type='text/javascript'>
  //async post thread
$(document).ready(function(){
  //prevent csrf attack
  $.ajaxSetup({
      beforeSend: function(xhr, settings) {
          if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
              xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}")
          }
      }
  })

  $(document).on("submit", "form[name='create_card']", function(e){
    e.preventDefault();
    var title = $(this).find("textarea[name='title']").val()
    var list_id = $(this).find("input[name='list_id']").val()
    var div_list_cards = $(this).parent().parent()
    console.log(div_list_cards)
    if($('div[name=server-error]').length > 0){
      $('div[name=server-error]').remove()
    }
    $.ajax({
      type: "POST",
      url: '/c',
      data: {title: title,
             list_id: list_id},
      success: function(result) {
        div_list_cards.find('.list-cards-add-form').hide()
        var card_div = $('<div class="list-card panel"><a class="list-card-hover"><a class="list-card-hover" data-toggle="modal" data-target="#card-modal-0"><div class="list-card-title">{card.title}</div><div class="list-card-badgets"><div class="list-card-badget list-card-badgets-comments"><span class="glyphicon glyphicon-comment"></span> 0</div><div class="list-card-badget list-card-badgets-attachments"><span class="glyphicon glyphicon-paperclip"></span> 0</div></div><div class="list-card-members"><div class="list-card-member">{{title}}</div></div></a></div>')
        div_list_cards.find('.js-list-cards-add').before(card_div);
        div_list_cards.find('.js-list-cards-add').show()
        card_div.find('.list-card-title').html(title);

      },
      error: function(msg) {
        var msg_div = "<div name='server-error' class='alert alert-danger'>Server Error: Please try to submit again later.</div>"
        $('div[name="comment-panel"]').append(msg_div);
      } 
    })
  });
  $("form[name='create_list']").submit(function(e){
      e.preventDefault();
      var title = $(this).find("textarea[name='title']").val();
      var board_id = $(this).find("input[name='board_id']").val();
      if($('div[name=server-error]').length > 0){
        $('div[name=server-error]').remove()
      }

      $.ajax({
        type: "POST",
        url: '/l',
        data: {title: title, board_id: board_id},
        success: function(result) {
          var list_id = result['list_id']
          $(this).find("textarea[name='list_title']").val('');
          var list_div = $('<div class="list-board"><div class="list-header-board"></div><div class="list-cards"><div class="js-list-cards-add"><a href="#"><div class="list-cards-add">Add a card...</div></a></div><div class="list-cards-add-form"><form name="create_card">{{ add_card_form.csrf_token }}{{ add_card_form.title(class="list-cards-add-textarea") }}<input id="list_id" name="list_id" type="hidden" value='+list_id+'><div class="list-cards-add-form-control"><input type="submit" class="btn btn-success" value="Add" /><a class="close"><span class="glyphicon glyphicon-remove"></span></a></div></form></div></div></div>')
          $('.add-new-list').before(list_div);
          list_div.find('.list-cards-add-form').hide()
          list_div.find('.list-header-board').html(title);
          $('.list-list-add-form').hide()
          $('.js-add-new-list').show()

        },
        error: function(msg) {
          var msg_div = "<div name='server-error' class='alert alert-danger'>Server Error: Please try to submit again later.</div>"
          $('div[name="comment-panel"]').append(msg_div);
        }
    })
  })
  $("form[name='edit-card-desc']").submit(function(e){
      e.preventDefault();
      var desc = $(this).find("textarea[name='desc']").val();
      var card_id = $(this).find("input[name='card_id']").val();
      var div_lists = $(document).find('.add-new-list')
      if($('div[name=server-error]').length > 0){
        $('div[name=server-error]').remove()
      }
      $.ajax({
        type: "POST",
        url: '/c/'+card_id,
        data: {desc: desc, card_id: card_id},
        success: function(result) {
          if (desc == ''){
            var desc_inner = '<span class="glyphicon glyphicon-pencil" style="padding-right:4px;"></span><a class="js-show-edit-card-desc-form" href="#">Edit the desciption...</a>'
          }else{
            var desc_inner = '<div class="card-description-title">Description <a class="js-show-edit-card-desc-form" href="#">Edit</a></div><div>' + desc + '</div>'
          }
          $('.card-description').html(desc_inner)
          $("form[name='edit-card-desc']").hide()
          $('.card-description').show()
        },
        error: function(msg) {
          var msg_div = "<div name='server-error' class='alert alert-danger'>Server Error: Please try to submit again later.</div>"
          $('div[name="comment-panel"]').append(msg_div);
        }
    })
  })  
})
</script>

{% endblock %}